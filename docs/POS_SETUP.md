# راهنمای راه‌اندازی کارت‌خوان POS

این راهنما نحوه راه‌اندازی و استفاده از کارت‌خوان POS برای پرداخت را توضیح می‌دهد.

## پیش‌نیازها

### روش 1: استفاده از DLL (پیشنهادی اگر DLL موجود است)

اگر فایل DLL از پرداخت نوین در دسترس دارید:

1. فایل DLL را در مسیر مشخصی قرار دهید (مثلاً `C:/POS/POS.dll`)
2. در Windows، DLL به صورت خودکار قابل استفاده است
3. در Linux/Mac، نیاز به Wine یا روش‌های دیگر دارید

### روش 2: استفاده مستقیم از پروتکل (بدون DLL)

اگر DLL موجود نیست یا نمی‌خواهید از آن استفاده کنید:

1. نصب کتابخانه `pyserial` برای ارتباط سریال:
```bash
pip install pyserial>=3.5
```

2. اتصال کارت‌خوان به سیستم:
   - **سریال**: اتصال از طریق پورت COM (Windows) یا /dev/ttyUSB0 (Linux)
   - **TCP/IP**: اتصال از طریق شبکه با IP و Port مشخص

## تنظیمات

### متغیرهای محیطی (.env)

```env
# انتخاب نوع Gateway
PAYMENT_GATEWAY_NAME=pos
PAYMENT_GATEWAY_ACTIVE=True

# انتخاب روش ارتباط (DLL یا پروتکل مستقیم)
POS_USE_DLL=False  # True اگر می‌خواهید از DLL استفاده کنید
POS_DLL_PATH=C:/POS/POS.dll  # مسیر فایل DLL (فقط اگر POS_USE_DLL=True)

# تنظیمات کارت‌خوان (برای روش پروتکل مستقیم)
POS_CONNECTION_TYPE=tcp  # یا 'serial'
POS_TCP_HOST=192.168.1.100
POS_TCP_PORT=1362
POS_SERIAL_PORT=COM1  # یا /dev/ttyUSB0 برای Linux
POS_SERIAL_BAUDRATE=9600
POS_TIMEOUT=30

# اطلاعات ترمینال
PAYMENT_GATEWAY_MERCHANT_ID=your_merchant_id
PAYMENT_GATEWAY_TERMINAL_ID=your_terminal_id
```

## انتخاب روش ارتباط

### استفاده از DLL (اگر موجود است)

**مزایا:**
- استفاده از کتابخانه رسمی پرداخت نوین
- پشتیبانی بهتر از ویژگی‌های خاص دستگاه
- مدیریت خودکار اتصال و خطاها

**نحوه استفاده:**
1. فایل DLL را از پرداخت نوین دریافت کنید
2. DLL را در مسیر مشخصی قرار دهید
3. `POS_USE_DLL=True` را در `.env` تنظیم کنید
4. `POS_DLL_PATH` را به مسیر DLL تنظیم کنید

**نکته:** DLL معمولاً فقط در Windows کار می‌کند. برای Linux/Mac نیاز به Wine یا روش‌های دیگر دارید.

### استفاده از پروتکل مستقیم (بدون DLL)

**مزایا:**
- کار در همه سیستم‌عامل‌ها (Windows, Linux, Mac)
- کنترل کامل بر پروتکل ارتباطی
- عدم وابستگی به DLL

**نحوه استفاده:**
1. `POS_USE_DLL=False` را در `.env` تنظیم کنید
2. تنظیمات اتصال (TCP یا Serial) را انجام دهید
3. سیستم به صورت خودکار از پروتکل مستقیم استفاده می‌کند

## نحوه استفاده

### 1. ساخت سفارش

```bash
POST /api/kiosk/orders/create/
{
  "items": [
    {
      "product_id": 1,
      "quantity": 2
    }
  ]
}
```

### 2. شروع پرداخت

```bash
POST /api/kiosk/payment/initiate/
{
  "order_id": 1,
  "amount": 50000
}
```

این درخواست:
- به کارت‌خوان متصل می‌شود
- مبلغ را به کارت‌خوان ارسال می‌کند
- منتظر می‌ماند تا مشتری کارت بکشد و رمز وارد کند
- نتیجه تراکنش را برمی‌گرداند

### 3. تایید پرداخت

```bash
POST /api/kiosk/payment/verify/
{
  "transaction_id": "TXN-20231227120000-1234"
}
```

این درخواست:
- وضعیت تراکنش را بررسی می‌کند
- اگر پرداخت موفق بود، موجودی کالا را کم می‌کند
- وضعیت سفارش را به 'paid' تغییر می‌دهد

## تنظیمات کارت‌خوان

### برای اتصال سریال:

1. کارت‌خوان را از طریق کابل سریال به کامپیوتر متصل کنید
2. در تنظیمات کارت‌خوان، اتصال به رایانه را فعال کنید
3. پورت سریال را در `.env` تنظیم کنید

### برای اتصال TCP/IP:

1. کارت‌خوان را از طریق کابل شبکه به مودم متصل کنید
2. IP کارت‌خوان را تنظیم کنید (مثلاً: 192.168.1.100)
3. Port را تنظیم کنید (پیش‌فرض: 1362)
4. در منوی F1 کارت‌خوان:
   - تنظیم پایانه → اتصال به رایانه → شبکه
   - IP و Port را وارد کنید
   - Test Connection را برای اطمینان از ارتباط تست کنید
5. IP و Port را در `.env` تنظیم کنید

## عیب‌یابی

### مشکل: اتصال برقرار نمی‌شود

- بررسی کنید که IP و Port درست باشند
- مطمئن شوید که کارت‌خوان و کامپیوتر در یک شبکه هستند
- برای سریال، بررسی کنید که پورت درست باشد

### مشکل: تراکنش ناموفق است

- بررسی کنید که کارت‌خوان به درستی تنظیم شده باشد
- مطمئن شوید که Merchant ID و Terminal ID درست هستند
- لاگ‌های سیستم را بررسی کنید

## لاگ‌ها

تمام تراکنش‌ها در جدول `Transaction` ذخیره می‌شوند و شامل:
- اطلاعات درخواست (`gateway_request_data`)
- پاسخ Gateway (`gateway_response_data`)
- وضعیت تراکنش (`status`)
- پیام خطا در صورت وجود (`error_message`)

## نکات مهم

1. **امنیت**: مطمئن شوید که IP کارت‌خوان فقط از داخل شبکه قابل دسترسی باشد
2. **Timeout**: در صورت عدم پاسخ کارت‌خوان، timeout تنظیم شده اعمال می‌شود
3. **موجودی**: موجودی کالا فقط بعد از تایید پرداخت کم می‌شود
4. **لغو سفارش**: در صورت لغو سفارش پرداخت شده، موجودی برگردانده می‌شود

